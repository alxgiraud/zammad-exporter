<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zammad Ticket Exporter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input[type="text"]:focus {
            border-color: #007bff;
            outline: none;
        }
        button {
            width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            background-color: #007bff;
            color: white;
            margin-top: 30px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .progress-container {
            display: none;
            margin-top: 20px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: #666;
        }
        .alert {
            padding: 12px;
            margin-top: 20px;
            border-radius: 4px;
            display: none;
        }
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Zammad Ticket Exporter</h1>
        
        <div class="form-group">
            <label for="instanceName">Zammad Instance Name:</label>
            <input type="text" id="instanceName" placeholder="myinstance (for https://myinstance.zammad.com)">
        </div>
        
        <div class="form-group">
            <label for="apiToken">API Token:</label>
            <input type="text" id="apiToken" placeholder="Your Zammad API token">
        </div>
        
        <button onclick="exportData()">Export CSV</button>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Initializing...</div>
        </div>
        
        <div class="alert alert-error" id="errorAlert"></div>
        <div class="alert alert-success" id="successAlert"></div>
    </div>

    <script>
        // Global variables for caching reference data
        let users = new Map();
        let groups = new Map();
        let organizations = new Map();
        let states = new Map();
        let priorities = new Map();
        let baseUrl = '';
        let apiToken = '';

        // Show/hide progress bar
        function showProgress(show = true) {
            const container = document.getElementById('progressContainer');
            container.style.display = show ? 'block' : 'none';
            if (!show) {
                updateProgress(0, '');
            }
        }

        // Update progress bar
        function updateProgress(percentage, text) {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = text;
        }

        // Show alert messages
        function showAlert(message, type = 'error') {
            const errorAlert = document.getElementById('errorAlert');
            const successAlert = document.getElementById('successAlert');
            
            // Hide both alerts first
            errorAlert.style.display = 'none';
            successAlert.style.display = 'none';
            
            if (type === 'error') {
                errorAlert.textContent = message;
                errorAlert.style.display = 'block';
            } else {
                successAlert.textContent = message;
                successAlert.style.display = 'block';
            }
        }

        // Make API request via Cloudflare with Authorization header
        async function makeApiRequest(endpoint) {
            const targetUrl = `${baseUrl}/api/v1/${endpoint}`;
            const proxyUrl = `https://zammad.alexandre-giraud89.workers.dev/?url=${encodeURIComponent(targetUrl)}`;
            
            const response = await fetch(proxyUrl, {
                method: 'GET',
                headers: {
                    'Authorization': `Token token=${apiToken}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.status} - ${response.statusText}`);
            }

            return await response.json();
        }

        // Get ticket tags
        async function getTicketTags(ticketId) {
            try {
                const response = await makeApiRequest(`tags?object=Ticket&o_id=${ticketId}`);
                return response.tags || [];
            } catch (error) {
                console.warn(`Failed to get tags for ticket ${ticketId}:`, error);
                return [];
            }
        }

        // Check if ticket has spam tag
        function hasSpamTag(tags) {
            return tags && tags.includes('spam');
        }

        // Load all reference data (users, groups, etc.)
        async function loadReferenceData() {
            updateProgress(10, 'Loading users...');
            const usersData = await makeApiRequest('users');
            usersData.forEach(user => users.set(user.id, user));

            updateProgress(15, 'Loading groups...');
            const groupsData = await makeApiRequest('groups');
            groupsData.forEach(group => groups.set(group.id, group));

            updateProgress(20, 'Loading organizations...');
            const orgsData = await makeApiRequest('organizations');
            orgsData.forEach(org => organizations.set(org.id, org));

            updateProgress(25, 'Loading ticket states...');
            const statesData = await makeApiRequest('ticket_states');
            statesData.forEach(state => states.set(state.id, state));

            updateProgress(30, 'Loading ticket priorities...');
            const prioritiesData = await makeApiRequest('ticket_priorities');
            prioritiesData.forEach(priority => priorities.set(priority.id, priority));
        }

        // Get all tickets with pagination
        async function getAllTickets() {
            let allTickets = [];
            let page = 1;
            let hasMorePages = true;

            while (hasMorePages) {
                updateProgress(30 + (page * 3), `Loading tickets page ${page}...`);
                
                const response = await makeApiRequest(`tickets?page=${page}&per_page=100&expand=true`);
                
                if (response && response.length > 0) {
                    allTickets = allTickets.concat(response);
                    page++;
                    // Zammad returns less than per_page when it's the last page
                    hasMorePages = response.length === 100;
                } else {
                    hasMorePages = false;
                }
            }

            return allTickets;
        }

        // Get user name by ID
        function getUserName(userId) {
            const user = users.get(userId);
            if (!user) return 'Unknown';
            return `${user.firstname || ''} ${user.lastname || ''}`.trim() || 'Unknown';
        }

        // Get user email by ID
        function getUserEmail(userId) {
            const user = users.get(userId);
            return user?.email || 'Unknown';
        }

        // Enrich ticket data with references
        async function enrichTicket(ticket, index, total) {
            const progressBase = 50;
            const progressRange = 40;
            const currentProgress = progressBase + (index / total * progressRange);
            
            updateProgress(currentProgress, `Processing ticket ${index + 1}/${total} - Getting tags...`);
            
            // Get ticket tags
            const tags = await getTicketTags(ticket.id);
            
            if (hasSpamTag(tags)) {
                return null; // Skip tickets with spam tag
            }

            updateProgress(currentProgress + 0.5, `Processing ticket ${index + 1}/${total} - Enriching data...`);

            return {
                id: ticket.id,
                number: ticket.number,
                title: ticket.title,
                state: states.get(ticket.state_id)?.name || 'Unknown',
                priority: priorities.get(ticket.priority_id)?.name || 'Unknown',
                group: groups.get(ticket.group_id)?.name || 'Unknown',
                customer: {
                    id: ticket.customer_id,
                    name: getUserName(ticket.customer_id),
                    email: getUserEmail(ticket.customer_id),
                    organization: organizations.get(users.get(ticket.customer_id)?.organization_id)?.name || 'None'
                },
                owner: {
                    id: ticket.owner_id,
                    name: ticket.owner_id ? getUserName(ticket.owner_id) : 'Unassigned',
                    email: ticket.owner_id ? getUserEmail(ticket.owner_id) : 'Unknown'
                },
                created_at: ticket.created_at,
                updated_at: ticket.updated_at,
                created_by: getUserName(ticket.created_by_id),
                updated_by: getUserName(ticket.updated_by_id),
                close_at: ticket.close_at,
                last_close_at: ticket.last_close_at,
                
                // Response times
                first_response_at: ticket.first_response_at,
                first_response_escalation_at: ticket.first_response_escalation_at,
                first_response_in_min: ticket.first_response_in_min,
                first_response_diff_in_min: ticket.first_response_diff_in_min,
                
                // Close times
                close_escalation_at: ticket.close_escalation_at,
                close_in_min: ticket.close_in_min,
                close_diff_in_min: ticket.close_diff_in_min,
                
                // Update times
                update_escalation_at: ticket.update_escalation_at,
                update_in_min: ticket.update_in_min,
                update_diff_in_min: ticket.update_diff_in_min,
                
                // Contact information
                last_contact_at: ticket.last_contact_at,
                last_contact_agent_at: ticket.last_contact_agent_at,
                last_contact_customer_at: ticket.last_contact_customer_at,
                last_owner_update_at: ticket.last_owner_update_at,
                
                // Article information
                create_article_type_id: ticket.create_article_type_id,
                create_article_sender_id: ticket.create_article_sender_id,
                article_count: ticket.article_count,
                
                // Other fields
                escalation_at: ticket.escalation_at,
                pending_time: ticket.pending_time,
                type: ticket.type,
                time_unit: ticket.time_unit,
                note: ticket.note,
                
                // Custom fields (corrected typo)
                projectcategory: ticket.projectcategory || '',
                terminal: ticket.terminal || '',
                requesttype: ticket.requesttype || '',
                interventiontype: ticket.interventiontype || '',
                service: ticket.service || '',
                platform: ticket.platform || '',
                requestedby: ticket.requestedby || '', // Corrected from requesetedby
                
                // Tags
                tags: tags.join(', ')
            };
        }

        // Convert enriched tickets to CSV
        function exportToCSV(tickets) {
            if (tickets.length === 0) {
                throw new Error('No tickets to export');
            }

            const headers = [
                'ID', 'Number', 'Title', 'State', 'Priority', 'Group',
                'Customer Name', 'Customer Email', 'Customer Organization',
                'Owner Name', 'Owner Email',
                'Created At', 'Updated At', 'Created By', 'Updated By',
                'Close At', 'Last Close At',
                'First Response At', 'First Response Escalation At', 'First Response In Min', 'First Response Diff In Min',
                'Close Escalation At', 'Close In Min', 'Close Diff In Min',
                'Update Escalation At', 'Update In Min', 'Update Diff In Min',
                'Last Contact At', 'Last Contact Agent At', 'Last Contact Customer At', 'Last Owner Update At',
                'Create Article Type ID', 'Create Article Sender ID', 'Article Count',
                'Escalation At', 'Pending Time', 'Type', 'Time Unit', 'Note',
                'Project Category', 'Terminal', 'Request Type', 'Intervention Type',
                'Service', 'Platform', 'Requested By', 'Tags'
            ];

            const csvContent = [
                headers.join(','),
                ...tickets.map(ticket => [
                    ticket.id,
                    `"${ticket.number}"`,
                    `"${(ticket.title || '').replace(/"/g, '""')}"`,
                    `"${ticket.state}"`,
                    `"${ticket.priority}"`,
                    `"${ticket.group}"`,
                    `"${ticket.customer.name}"`,
                    `"${ticket.customer.email}"`,
                    `"${ticket.customer.organization}"`,
                    `"${ticket.owner.name}"`,
                    `"${ticket.owner.email}"`,
                    `"${ticket.created_at || ''}"`,
                    `"${ticket.updated_at || ''}"`,
                    `"${ticket.created_by}"`,
                    `"${ticket.updated_by}"`,
                    `"${ticket.close_at || ''}"`,
                    `"${ticket.last_close_at || ''}"`,
                    `"${ticket.first_response_at || ''}"`,
                    `"${ticket.first_response_escalation_at || ''}"`,
                    `"${ticket.first_response_in_min || ''}"`,
                    `"${ticket.first_response_diff_in_min || ''}"`,
                    `"${ticket.close_escalation_at || ''}"`,
                    `"${ticket.close_in_min || ''}"`,
                    `"${ticket.close_diff_in_min || ''}"`,
                    `"${ticket.update_escalation_at || ''}"`,
                    `"${ticket.update_in_min || ''}"`,
                    `"${ticket.update_diff_in_min || ''}"`,
                    `"${ticket.last_contact_at || ''}"`,
                    `"${ticket.last_contact_agent_at || ''}"`,
                    `"${ticket.last_contact_customer_at || ''}"`,
                    `"${ticket.last_owner_update_at || ''}"`,
                    `"${ticket.create_article_type_id || ''}"`,
                    `"${ticket.create_article_sender_id || ''}"`,
                    `"${ticket.article_count || ''}"`,
                    `"${ticket.escalation_at || ''}"`,
                    `"${ticket.pending_time || ''}"`,
                    `"${ticket.type || ''}"`,
                    `"${ticket.time_unit || ''}"`,
                    `"${(ticket.note || '').replace(/"/g, '""')}"`,
                    `"${ticket.projectcategory}"`,
                    `"${ticket.terminal}"`,
                    `"${ticket.requesttype}"`,
                    `"${ticket.interventiontype}"`,
                    `"${ticket.service}"`,
                    `"${ticket.platform}"`,
                    `"${ticket.requestedby}"`,
                    `"${ticket.tags}"`
                ].join(','))
            ].join('\n');

            // Create CSV with UTF-8 BOM for proper encoding
            const BOM = '\uFEFF';
            const dataBlob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `zammad_tickets_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        // Main export function
        async function exportData() {
            // Clear previous alerts
            document.getElementById('errorAlert').style.display = 'none';
            document.getElementById('successAlert').style.display = 'none';

            // Validate inputs
            const instanceName = document.getElementById('instanceName').value.trim();
            apiToken = document.getElementById('apiToken').value.trim();

            if (!instanceName || !apiToken) {
                showAlert('Please provide both instance name and API token');
                return;
            }

            baseUrl = `https://${instanceName}.zammad.com`;

            // Disable button during export
            const button = document.querySelector('button');
            button.disabled = true;

            try {
                showProgress(true);
                updateProgress(0, 'Starting export...');

                // Clear caches
                users.clear();
                groups.clear();
                organizations.clear();
                states.clear();
                priorities.clear();

                // Load reference data
                await loadReferenceData();

                // Get all tickets
                updateProgress(35, 'Loading tickets...');
                const rawTickets = await getAllTickets();

                // Enrich tickets with detailed information (including tags check)
                updateProgress(50, 'Enriching ticket data and checking tags...');
                const enrichedTickets = [];
                
                for (let i = 0; i < rawTickets.length; i++) {
                    const enriched = await enrichTicket(rawTickets[i], i, rawTickets.length);
                    if (enriched) { // Only add non-spam tickets
                        enrichedTickets.push(enriched);
                    }
                }

                updateProgress(95, 'Preparing download...');

                // Export to CSV
                exportToCSV(enrichedTickets);

                updateProgress(100, 'Export completed!');
                showAlert(`Successfully exported ${enrichedTickets.length} tickets (${rawTickets.length - enrichedTickets.length} spam tickets excluded)`, 'success');

            } catch (error) {
                console.error('Export error:', error);
                showAlert(`Export failed: ${error.message}`);
            } finally {
                // Re-enable button
                button.disabled = false;
                setTimeout(() => showProgress(false), 2000);
            }
        }
    </script>
</body>
</html>
